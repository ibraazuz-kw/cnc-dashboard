<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø¯Ù…Ù†</title>
  <style>
    body{font-family:Arial;background:#f5f5f5;margin:0}
    header{background:#198754;color:#fff;padding:16px}
    .wrap{max-width:1100px;margin:18px auto;padding:0 12px}
    .card{background:#fff;border-radius:14px;padding:14px;box-shadow:0 10px 25px rgba(0,0,0,.06);margin-bottom:12px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media(max-width:800px){.row{grid-template-columns:1fr}}
    label{display:block;margin:10px 0 6px;font-weight:bold}
    input,select{width:100%;padding:12px;border:1px solid #ddd;border-radius:12px;font-size:15px;box-sizing:border-box}
    button{padding:14px;border:0;border-radius:12px;font-size:16px;font-weight:bold;cursor:pointer}
    .refresh{background:#111;color:#fff;width:100%}
    .danger{background:#d32f2f;color:#fff;width:100%;margin-top:8px}
    .order{background:#fafafa;border:1px solid #eee;border-radius:12px;padding:12px;margin-top:10px}
    .small{color:#555;font-size:14px;margin:3px 0}
    .pill{display:inline-block;background:#f1f2f6;padding:6px 10px;border-radius:999px;font-size:13px;margin-top:6px}
    .wa{background:#25D366;color:#111;width:100%;margin-top:8px}
    .blue{background:#0d6efd;color:#fff;width:100%;margin-top:8px}
  </style>
</head>
<body>

<header>
  <div class="wrap" style="font-size:18px;font-weight:bold">Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø¯Ù…Ù† - Pro Design</div>
</header>

<div class="wrap">

  <div class="card">
    <h3 style="margin:0 0 10px">ğŸ” ÙÙ„ØªØ±Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h3>
    <label>Ø§Ø®ØªØ± Ø´Ø±ÙƒØ© Ø§Ù„Ø¹Ù…ÙŠÙ„</label>
    <select id="filterCompany" onchange="render()">
      <option value="all">ÙƒÙ„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</option>
    </select>

    <button class="refresh" onclick="render()">ØªØ­Ø¯ÙŠØ«</button>
    <button class="danger" onclick="resetAll()">Ø­Ø°Ù ÙƒÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª (ØªØ¬Ø±Ø¨Ø©)</button>
  </div>

  <div class="card">
    <h3 style="margin:0 0 10px">ğŸ“¦ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h3>
    <div id="orders"></div>
  </div>

</div>

<script>
  function getOrders(){
    return JSON.parse(localStorage.getItem("CNC_ORDERS") || "[]");
  }
  function saveOrders(data){
    localStorage.setItem("CNC_ORDERS", JSON.stringify(data));
  }
  function getUsers(){
    return JSON.parse(localStorage.getItem("CNC_USERS") || "[]");
  }

  function resetAll(){
    if(!confirm("Ø£ÙƒÙŠØ¯ ØªØ¨ÙŠ Ø­Ø°Ù ÙƒÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§ØªØŸ")) return;
    localStorage.removeItem("CNC_ORDERS");
    render();
  }

  function badge(status){
    if(status === "Ø¬Ø§Ù‡Ø²") return "âœ… Ø¬Ø§Ù‡Ø²";
    if(status === "Ù‚ÙŠØ¯ Ø§Ù„ØªØ´ØºÙŠÙ„") return "â³ Ù‚ÙŠØ¯ Ø§Ù„ØªØ´ØºÙŠÙ„";
    return "ğŸ†• Ø¬Ø¯ÙŠØ¯";
  }

  function setStatus(orderId, status){
    const orders = getOrders();
    const o = orders.find(x => x.id === orderId);
    if(!o) return;
    o.status = status;
    saveOrders(orders);
    render();
  }

  function openWhatsApp(company){
    const users = getUsers();
    const u = users.find(x => x.company === company);
    const phone = u?.phone ? u.phone.replace(/\s/g,"") : "";
    if(!phone){
      alert("Ø±Ù‚Ù… ÙˆØ§ØªØ³Ø§Ø¨ Ø§Ù„Ø¹Ù…ÙŠÙ„ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø®Ù„ Ø­Ø³Ø§Ø¨Ù‡ ÙÙŠ Ø§Ù„Ø£Ø¯Ù…Ù†");
      return;
    }
    const msg = encodeURIComponent("Ø§Ù„Ø³Ù„Ø§Ù… Ø¹Ù„ÙŠÙƒÙ…ØŒ Ø¨Ø®ØµÙˆØµ Ø·Ù„Ø¨ÙƒÙ… ÙÙŠ Pro Design CNC.");
    window.open("https://wa.me/" + phone + "?text=" + msg, "_blank");
  }

  function fileToBase64(file){
    return new Promise((resolve) => {
      if(!file) return resolve(null);
      const r = new FileReader();
      r.onload = () => resolve(r.result);
      r.readAsDataURL(file);
    });
  }

  async function uploadDesignerPdf(orderId, inputId){
    const file = document.getElementById(inputId).files[0];
    if(!file){
      alert("Ø§Ø®ØªØ± Ù…Ù„Ù PDF Ø£ÙˆÙ„Ø§Ù‹");
      return;
    }
    if(!file.name.toLowerCase().endsWith(".pdf")){
      alert("Ù„Ø§Ø²Ù… ÙŠÙƒÙˆÙ† Ø§Ù„Ù…Ù„Ù PDF");
      return;
    }

    const data = await fileToBase64(file);

    const orders = getOrders();
    const o = orders.find(x => x.id === orderId);
    if(!o) return;

    o.designerPdf = { name: file.name, data };
    saveOrders(orders);

    alert("ØªÙ… Ø±ÙØ¹ PDF Ù„Ù„Ù…ØµÙ…Ù… âœ…");
    render();
  }

  function render(){
    const orders = getOrders();
    const users = getUsers();

    // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„ÙÙ„ØªØ±
    const filter = document.getElementById("filterCompany");
    const companies = [...new Set(orders.map(o => o.company))];

    // Ø­ÙØ¸ Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ
    const current = filter.value || "all";
    filter.innerHTML = `<option value="all">ÙƒÙ„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</option>` +
      companies.map(c => `<option value="${c}">${c}</option>`).join("");
    filter.value = current;

    // ÙÙ„ØªØ±Ø©
    const selected = filter.value;
    const filtered = selected === "all" ? orders : orders.filter(o => o.company === selected);

    const ordersDiv = document.getElementById("orders");
    if(filtered.length === 0){
      ordersDiv.innerHTML = "<div class='small'>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª.</div>";
      return;
    }

    ordersDiv.innerHTML = filtered.map((o, idx) => {
      const inputId = "pdf_" + o.id;

      return `
        <div class="order">
          <div><b>${o.company}</b> - ${o.orderType}</div>
          <div class="small">ğŸ•’ ${o.createdAt}</div>
          <div class="small">ğŸ“Œ Ø§Ù„Ø­Ø§Ù„Ø©: <b>${badge(o.status || "Ø¬Ø¯ÙŠØ¯")}</b></div>
          <div class="small">ğŸ“ Ø´ÙŠØª: ${o.sheet.size} | Ø³Ù…Ø§ÙƒØ©: ${o.sheet.thickness}mm | Ù…Ø§Ø¯Ø©: ${o.sheet.material} | Ø¹Ø¯Ø¯: ${o.sheet.qty}</div>
          <div class="small">ğŸ›  Ø¹Ø±Ø¶ Ø§Ù„Ø®Ø·: ${o.cutting.lineWidth}</div>
          <div class="small">ğŸ“ ØªÙØ§ØµÙŠÙ„: ${o.cutting.jobDetails || "-"}</div>
          <div class="small">âœï¸ ÙŠØ¯ÙˆÙŠ: ${o.manual ? o.manual.replace(/\n/g," / ") : "-"}</div>
          <div class="small">ğŸ“ Ù…Ù„Ø§Ø­Ø¸Ø§Øª: ${o.notes ? o.notes.replace(/\n/g," / ") : "-"}</div>

          <div class="small" style="margin-top:8px"><b>ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø©:</b></div>
          <div class="row">
            <button class="blue" onclick="setStatus('${o.id}','Ø¬Ø¯ÙŠØ¯')">ğŸ†• Ø¬Ø¯ÙŠØ¯</button>
            <button class="blue" onclick="setStatus('${o.id}','Ù‚ÙŠØ¯ Ø§Ù„ØªØ´ØºÙŠÙ„')">â³ Ù‚ÙŠØ¯ Ø§Ù„ØªØ´ØºÙŠÙ„</button>
            <button class="blue" onclick="setStatus('${o.id}','Ø¬Ø§Ù‡Ø²')">âœ… Ø¬Ø§Ù‡Ø²</button>
          </div>

          <button class="wa" onclick="openWhatsApp('${o.company}')">ğŸ“² ÙˆØ§ØªØ³Ø§Ø¨ Ø§Ù„Ø¹Ù…ÙŠÙ„</button>

          <div class="small" style="margin-top:8px"><b>ğŸ“„ Ø±ÙØ¹ PDF Ù„Ù„Ù…ØµÙ…Ù… (ÙŠØ¸Ù‡Ø± Ù„Ù„Ø¹Ù…ÙŠÙ„):</b></div>
          <input id="${inputId}" type="file" accept="application/pdf" />
          <button class="blue" onclick="uploadDesignerPdf('${o.id}','${inputId}')">Ø±ÙØ¹ PDF</button>

          <button class="danger" onclick="deleteOrder('${o.id}')">Ø­Ø°Ù Ø§Ù„Ø·Ù„Ø¨</button>
        </div>
      `;
    }).join("");
  }

  function deleteOrder(id){
    const orders = getOrders().filter(x => x.id !== id);
    saveOrders(orders);
    render();
  }

  render();
</script>

</body>
</html>
