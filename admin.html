<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø¯Ù…Ù†</title>
  <style>
    body{font-family:Arial;background:#f5f7fb;margin:0}
    .top{background:#111;color:#fff;padding:16px;text-align:center;font-size:18px;font-weight:900}
    .wrap{max-width:1100px;margin:20px auto;padding:12px}
    .card{background:#fff;border-radius:16px;padding:16px;margin-bottom:14px;box-shadow:0 10px 30px rgba(0,0,0,.06)}
    .title{font-size:18px;font-weight:900}
    .mini{font-size:12px;color:#666;margin-top:6px}
    .order{border:1px solid #eee;border-radius:16px;padding:14px;margin-top:12px}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .col{flex:1;min-width:220px}
    label{display:block;margin:10px 0 6px;font-weight:900}
    input,select,textarea{width:100%;padding:12px;border:1px solid #ddd;border-radius:12px;font-size:15px}
    textarea{min-height:90px}
    .btn{padding:12px 14px;border:none;border-radius:12px;font-size:15px;font-weight:900;cursor:pointer}
    .btnBlue{background:#0b63f6;color:#fff}
    .btnGreen{background:#12b76a;color:#fff}
    .btnRed{background:#e74c3c;color:#fff}
    .btnDark{background:#111;color:#fff}
    .boxText{background:#f7f7f7;border-radius:14px;padding:12px;border:1px dashed #ddd;white-space:pre-wrap}
    a{color:#0b63f6;text-decoration:none;font-weight:900}
  </style>
</head>
<body>

<div class="top">Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø¯Ù…Ù† (Ø·Ù„Ø¨Ø§Øª CNC)</div>

<div class="wrap">

  <div class="card">
    <div class="title">ğŸ§  Ù…Ù„Ø§Ø­Ø¸Ø©</div>
    <div class="mini">
      Ù‡Ø°Ø§ Ø¥ØµØ¯Ø§Ø± ØªØ¬Ø±ÙŠØ¨ÙŠ Ø¨Ø¯ÙˆÙ† Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª. Ø§Ù„Ø·Ù„Ø¨Ø§Øª ØªÙ†Ø­ÙØ¸ ÙÙŠ Ù†ÙØ³ Ø§Ù„Ø¬Ù‡Ø§Ø² (LocalStorage).
    </div>
    <div style="margin-top:10px">
      <a href="/index.html">Ø±Ø¬ÙˆØ¹ Ù„Ù„Ø¨ÙˆØ§Ø¨Ø©</a>
    </div>
  </div>

  <div class="card">
    <div class="title">ğŸ“¥ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø³ØªÙ„Ù…Ø©</div>
    <div class="mini">ØªÙ‚Ø¯Ø± ØªØºÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨ + ØªØ³Ø¹ÙŠØ± + Ø®ØµÙ… + Ø¥Ø±Ø³Ø§Ù„ ÙØ§ØªÙˆØ±Ø© Ù„Ù„Ø¹Ù…ÙŠÙ„.</div>

    <div style="margin-top:12px" class="row">
      <button class="btn btnBlue" onclick="loadOrders()">ğŸ”„ ØªØ­Ø¯ÙŠØ«</button>
      <button class="btn btnRed" onclick="clearAll()">ğŸ—‘ï¸ Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª (ØªØ¬Ø±Ø¨Ø©)</button>
    </div>

    <div id="ordersList"></div>
  </div>

</div>

<script>
  const ordersList = document.getElementById("ordersList");

  function loadOrders(){
    const orders = JSON.parse(localStorage.getItem("pd_orders") || "[]");
    ordersList.innerHTML = "";

    if(orders.length === 0){
      ordersList.innerHTML = `<div class="boxText">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹.</div>`;
      return;
    }

    orders.forEach((o, idx)=>{
      const div = document.createElement("div");
      div.className = "order";

      div.innerHTML = `
        <div class="title">Ø·Ù„Ø¨ Ø±Ù‚Ù…: ${o.id}</div>
        <div class="mini">Ø§Ù„Ø¹Ù…ÙŠÙ„: <b>${o.company}</b> | Ù†ÙˆØ¹ Ø§Ù„Ø·Ù„Ø¨: <b>${o.type}</b></div>

        <div style="margin-top:10px" class="boxText">${o.cncText}</div>

        <div class="row" style="margin-top:12px">
          <div class="col">
            <label>Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨ (Ù„Ù„Ø¹Ù…ÙŠÙ„)</label>
            <select id="st_${o.id}">
              <option>Ù‚ÙŠØ¯ Ø§Ù„ØªØ´ØºÙŠÙ„</option>
              <option>Ø¬Ø§Ù‡Ø²</option>
              <option>ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…</option>
              <option>Ù…Ù„ØºÙŠ</option>
            </select>
            <button class="btn btnGreen" style="margin-top:10px;width:100%" onclick="saveStatus('${o.user}','${o.id}')">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø­Ø§Ù„Ø©</button>
          </div>

          <div class="col">
            <label>Ø§Ù„ØªØ³Ø¹ÙŠØ±</label>
            <input id="cut_${o.id}" type="number" placeholder="Ø³Ø¹Ø± Ø§Ù„Ù‚Øµ (KD)" />
            <input id="engr_${o.id}" type="number" placeholder="Ø³Ø¹Ø± Ø§Ù„Ø­ÙØ± (KD)" style="margin-top:8px" />
            <input id="mat_${o.id}" type="number" placeholder="Ø³Ø¹Ø± Ø§Ù„Ù…Ø§Ø¯Ø©/Ø§Ù„Ø´ÙŠØª (KD)" style="margin-top:8px" />
          </div>

          <div class="col">
            <label>Ø®ØµÙ…</label>
            <input id="disc_${o.id}" type="number" placeholder="Ø®ØµÙ… (KD)" />
            <label style="margin-top:10px">Ù…Ù„Ø§Ø­Ø¸Ø© Ù„Ù„ÙØ§ØªÙˆØ±Ø©</label>
            <input id="invNote_${o.id}" placeholder="Ù…Ø«Ø§Ù„: Ø´Ø§Ù…Ù„ Ø§Ù„ØªØ±ÙƒÙŠØ¨ / ØªØ³Ù„ÙŠÙ… Ø®Ù„Ø§Ù„ ÙŠÙˆÙ…ÙŠÙ†" />
          </div>
        </div>

        <div class="row" style="margin-top:12px">
          <button class="btn btnDark" onclick="makeInvoice('${o.id}','${o.user}','${o.company}','${o.type}')">ğŸ§¾ Ø¥Ù†Ø´Ø§Ø¡ ÙØ§ØªÙˆØ±Ø© (Ù†Øµ)</button>
          <button class="btn btnBlue" onclick="sendInvoiceToClient('${o.id}','${o.user}')">ğŸ“¤ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ù„Ù„Ø¹Ù…ÙŠÙ„</button>
          <button class="btn btnRed" onclick="deleteOrder('${o.id}')">Ø­Ø°Ù Ø§Ù„Ø·Ù„Ø¨</button>
        </div>

        <div id="inv_${o.id}" class="boxText" style="margin-top:12px;display:none;"></div>
      `;

      ordersList.appendChild(div);

      // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø¥Ù† ÙˆØ¬Ø¯Øª
      const statuses = JSON.parse(localStorage.getItem("pd_statuses") || "{}");
      const st = statuses[o.user] || "Ù‚ÙŠØ¯ Ø§Ù„ØªØ´ØºÙŠÙ„";
      div.querySelector("#st_"+o.id).value = st;
    });
  }

  function saveStatus(user, orderId){
    const st = document.getElementById("st_"+orderId).value;
    const statuses = JSON.parse(localStorage.getItem("pd_statuses") || "{}");
    statuses[user] = st;
    localStorage.setItem("pd_statuses", JSON.stringify(statuses));
    alert("âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø­Ø§Ù„Ø© Ù„Ù„Ø¹Ù…ÙŠÙ„");
  }

  function makeInvoice(orderId, user, company, type){
    const cut = Number(document.getElementById("cut_"+orderId).value || 0);
    const engr = Number(document.getElementById("engr_"+orderId).value || 0);
    const mat = Number(document.getElementById("mat_"+orderId).value || 0);
    const disc = Number(document.getElementById("disc_"+orderId).value || 0);
    const note = document.getElementById("invNote_"+orderId).value.trim();

    const subtotal = cut + engr + mat;
    const total = Math.max(0, subtotal - disc);

    let text = "";
    text += "ğŸ§¾ ÙØ§ØªÙˆØ±Ø© Pro Design\n";
    text += "--------------------------\n";
    text += "Ø§Ù„Ø¹Ù…ÙŠÙ„: " + company + "\n";
    text += "Ù†ÙˆØ¹ Ø§Ù„Ø·Ù„Ø¨: " + type + "\n";
    text += "Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨: " + orderId + "\n";
    text += "Ø§Ù„ØªØ§Ø±ÙŠØ®: " + new Date().toLocaleString() + "\n";
    text += "--------------------------\n";
    text += "Ø³Ø¹Ø± Ø§Ù„Ù‚Øµ: " + cut.toFixed(3) + " KD\n";
    text += "Ø³Ø¹Ø± Ø§Ù„Ø­ÙØ±: " + engr.toFixed(3) + " KD\n";
    text += "Ø³Ø¹Ø± Ø§Ù„Ù…Ø§Ø¯Ø©/Ø§Ù„Ø´ÙŠØª: " + mat.toFixed(3) + " KD\n";
    text += "--------------------------\n";
    text += "Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù‚Ø¨Ù„ Ø§Ù„Ø®ØµÙ…: " + subtotal.toFixed(3) + " KD\n";
    text += "Ø§Ù„Ø®ØµÙ…: " + disc.toFixed(3) + " KD\n";
    text += "Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ: " + total.toFixed(3) + " KD\n";
    text += "--------------------------\n";
    text += "Ù…Ù„Ø§Ø­Ø¸Ø©: " + (note ? note : "Ù„Ø§ ÙŠÙˆØ¬Ø¯") + "\n";
    text += "âœ… Ø´ÙƒØ±Ø§Ù‹ Ù„ØªØ¹Ø§Ù…Ù„ÙƒÙ… Ù…Ø¹Ù†Ø§.\n";

    const box = document.getElementById("inv_"+orderId);
    box.style.display = "block";
    box.innerText = text;

    // Ù†Ø­ÙØ¸Ù‡Ø§ Ù…Ø¤Ù‚ØªØ§Ù‹ Ø¯Ø§Ø®Ù„ localStorage ÙƒÙØ§ØªÙˆØ±Ø© Ø¬Ø§Ù‡Ø²Ø©
    const invoicesDraft = JSON.parse(localStorage.getItem("pd_invoice_drafts") || "{}");
    invoicesDraft[orderId] = { user, text };
    localStorage.setItem("pd_invoice_drafts", JSON.stringify(invoicesDraft));

    alert("âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ÙØ§ØªÙˆØ±Ø© (Ù†Øµ). Ø§Ø¶ØºØ· Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„Ø¹Ù…ÙŠÙ„.");
  }

  function sendInvoiceToClient(orderId, user){
    const drafts = JSON.parse(localStorage.getItem("pd_invoice_drafts") || "{}");
    const d = drafts[orderId];
    if(!d){
      return alert("âš ï¸ Ø£Ù†Ø´Ø¦ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø£ÙˆÙ„Ø§Ù‹");
    }

    const invs = JSON.parse(localStorage.getItem("pd_invoices") || "{}");
    invs[user] = { text: d.text, orderId, sentAt: new Date().toISOString() };
    localStorage.setItem("pd_invoices", JSON.stringify(invs));

    alert("ğŸ“¤ ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ù„Ù„Ø¹Ù…ÙŠÙ„. (ØªØ¸Ù‡Ø± ÙÙŠ ØµÙØ­Ø© Ø§Ù„Ø¹Ù…ÙŠÙ„)");
  }

  function deleteOrder(orderId){
    let orders = JSON.parse(localStorage.getItem("pd_orders") || "[]");
    orders = orders.filter(o => o.id !== orderId);
    localStorage.setItem("pd_orders", JSON.stringify(orders));
    loadOrders();
  }

  function clearAll(){
    if(!confirm("Ù…ØªØ£ÙƒØ¯ ØªÙ…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§ØªØŸ")) return;
    localStorage.removeItem("pd_orders");
    localStorage.removeItem("pd_invoice_drafts");
    alert("ØªÙ… Ø§Ù„Ù…Ø³Ø­");
    loadOrders();
  }

  loadOrders();
</script>

</body>
</html>
