<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ØµÙØ­Ø© Ø§Ù„Ø¹Ù…ÙŠÙ„ - CNC</title>
  <style>
    body{font-family:Arial;background:#f5f7fb;margin:0}
    .top{background:#12b76a;color:#fff;padding:16px;text-align:center;font-size:18px;font-weight:900}
    .wrap{max-width:950px;margin:20px auto;padding:12px}
    .card{background:#fff;border-radius:16px;padding:16px;margin-bottom:14px;box-shadow:0 10px 30px rgba(0,0,0,.06)}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .col{flex:1;min-width:220px}
    label{display:block;margin:10px 0 6px;font-weight:800}
    input,select,textarea{width:100%;padding:12px;border:1px solid #ddd;border-radius:12px;font-size:15px}
    textarea{min-height:90px}
    .btn{padding:14px 14px;border:none;border-radius:12px;font-size:16px;font-weight:900;cursor:pointer}
    .btnRed{background:#e74c3c;color:#fff}
    .btnBlue{background:#0b63f6;color:#fff}
    .btnGreen{background:#12b76a;color:#fff}
    .btnDark{background:#111;color:#fff}
    .head{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap}
    .title{font-size:18px;font-weight:900}
    .badge{display:inline-block;padding:8px 12px;border-radius:999px;font-weight:900}
    .bWork{background:#fff3cd;color:#7a5b00;border:1px solid #ffeeba}
    .bDone{background:#d1f7e3;color:#0b7a44;border:1px solid #a9e9c8}
    .blueBar{background:#1f6fff;color:#fff;padding:12px;border-radius:14px;font-weight:900;margin:10px 0}
    .tableRow{display:flex;gap:10px;align-items:center;flex-wrap:wrap;padding:10px;border:1px solid #eee;border-radius:14px;margin:10px 0}
    .mini{font-size:12px;color:#666;margin-top:6px}
    .boxText{background:#f7f7f7;border-radius:14px;padding:12px;border:1px dashed #ddd;white-space:pre-wrap}
    .divider{height:1px;background:#eee;margin:12px 0}
    .pdfLink{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-top:10px}
    a{color:#0b63f6;text-decoration:none;font-weight:900}
  </style>
</head>
<body>

<div class="top">ØµÙØ­Ø© Ø§Ù„Ø¹Ù…ÙŠÙ„ (Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ CNC)</div>

<div class="wrap">

  <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„ + Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨ -->
  <div class="card">
    <div class="head">
      <div>
        <div class="title" id="hello">Ù…Ø±Ø­Ø¨Ø§Ù‹</div>
        <div class="mini">Ù‡Ø°Ù‡ ØµÙØ­Ø© Ø®Ø§ØµØ© Ù„Ù„Ø¹Ù…ÙŠÙ„ Ø¨Ø¹Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„.</div>
      </div>
      <button class="btn btnRed" onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
    </div>

    <div class="divider"></div>

    <div class="row">
      <div class="col">
        <div class="title">Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ø­Ø§Ù„ÙŠ</div>
        <div style="margin-top:10px">
          <span id="statusBadge" class="badge bWork">â³ Ù‚ÙŠØ¯ Ø§Ù„ØªØ´ØºÙŠÙ„</span>
        </div>
        <div class="mini">âœ… Ø§Ù„Ø¹Ù…ÙŠÙ„ ÙŠØ´ÙˆÙ Ø§Ù„Ø­Ø§Ù„Ø© ÙÙ‚Ø· (Ø¨Ø¯ÙˆÙ† ØªØºÙŠÙŠØ±).</div>
      </div>

      <div class="col">
        <div class="title">Ù†ÙˆØ¹ Ø§Ù„Ø·Ù„Ø¨</div>
        <select id="orderType">
          <option value="">Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø·Ù„Ø¨</option>
          <option>Ø¨Ø§Ø¨</option>
          <option>Ø¨Ø§Ø¨ Ù…ÙØ±Ø¯</option>
          <option>Ø¨Ø§Ø¨ Ù…Ø²Ø¯ÙˆØ¬</option>
          <option>Ø¨Ø§Ø¨ ÙˆÙ†Øµ</option>
          <option>Ø´Ø¨Ø§Ùƒ</option>
          <option>Ù‚Øµ Ø´ÙŠØª ÙÙ‚Ø·</option>
          <option>Ø­ÙØ± Ø´ÙŠØª ÙÙ‚Ø·</option>
        </select>
        <div class="mini">ØªÙ‚Ø¯Ø± ØªØºÙŠØ±Ù‡Ø§ Ø­Ø³Ø¨ Ø´ØºÙ„Ùƒ.</div>
      </div>
    </div>
  </div>

  <!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù‚ÙŠØ§Ø³Ø§Øª (Ø¨Ø§Ù„Ø³Ù†ØªÙŠÙ…ØªØ±) + Ø§ØªØ¬Ø§Ù‡ Ø§Ù„ÙØªØ­Ø© Ø¨Ø³Ù‡Ù… -->
  <div class="card">
    <div class="title">ğŸ“ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù‚ÙŠØ§Ø³Ø§Øª (Ø¨Ø§Ù„Ø³Ù†ØªÙŠÙ…ØªØ±)</div>
    <div class="mini">âš ï¸ Ù…Ù„Ø§Ø­Ø¸Ø©: Ø§Ù„Ø§ØªØ¬Ø§Ù‡ Ù…Ø­Ø³ÙˆØ¨ Ù…Ù† Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¨ÙŠØª (ÙŠÙ…ÙŠÙ†/ÙŠØ³Ø§Ø±).</div>

    <div class="blueBar">Ù… | Ø§Ù„Ø¹Ø±Ø¶ (Ø³Ù…) | Ø§Ù„Ø§Ø±ØªÙØ§Ø¹ (Ø³Ù…) | Ø§Ù„Ø¹Ø¯Ø¯ | Ø§ØªØ¬Ø§Ù‡ Ø§Ù„ÙØªØ­Ø©</div>

    <div id="measurements"></div>

    <button class="btn btnBlue" onclick="addMeasurement()">+ Ø¥Ø¶Ø§ÙØ© Ù‚ÙŠØ§Ø³</button>

    <div class="mini">Ù…Ø«Ø§Ù„: 110Ã—300 Ø¹Ø¯Ø¯ 1 Ø§ØªØ¬Ø§Ù‡ Ø§Ù„ÙØªØ­Ø© ÙŠÙ…ÙŠÙ†</div>
  </div>

  <!-- ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø´ÙŠØª -->
  <div class="card">
    <div class="title">ğŸ§¾ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø´ÙŠØª (Ù„Ù„Ø´Ø±Ø§Ø¡ Ù…Ù† Ø§Ù„Ù…ÙˆØ±Ø¯)</div>
    <div class="mini">Ø§Ø®ØªØ± Ù‚ÙŠØ§Ø³ Ø§Ù„Ø´ÙŠØª + Ø§Ù„Ø³Ù…Ø§ÙƒØ© + Ø§Ù„ÙƒÙ…ÙŠØ©. ÙˆØªÙ‚Ø¯Ø± ØªØ¶ÙŠÙ Ø£ÙƒØ«Ø± Ù…Ù† Ø´ÙŠØª.</div>

    <div class="blueBar">Ù‚ÙŠØ§Ø³ Ø§Ù„Ø´ÙŠØª | Ø§Ù„Ø³Ù…Ø§ÙƒØ© (mm) | Ø§Ù„ÙƒÙ…ÙŠØ© | Ø­Ø°Ù</div>

    <div id="sheets"></div>

    <button class="btn btnBlue" onclick="addSheet()">+ Ø¥Ø¶Ø§ÙØ© Ø´ÙŠØª</button>

    <div style="margin-top:12px">
      <button class="btn btnGreen" onclick="downloadSheetsPDF()">ğŸ“„ ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù PDF Ù„Ø·Ù„Ø¨ Ø§Ù„Ø´ÙŠØª</button>
      <div class="mini">ÙŠØ·Ù„Ø¹ Ù„Ùƒ PDF ÙÙŠÙ‡ Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ + ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø´ÙŠØªØ§Øª.</div>
    </div>
  </div>

  <!-- ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù‚Øµ ÙˆØ§Ù„Ø­ÙØ± + Ø±ÙØ¹ Ù…Ù„Ù -->
  <div class="card">
    <div class="title">âœ‚ï¸ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù‚Øµ / Ø§Ù„Ø­ÙØ±</div>

    <label>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù‚Øµ / Ø§Ù„Ø­ÙØ±</label>
    <textarea id="cutDetails" placeholder="Ù…Ø«Ø§Ù„: Ù‚Øµ Ø®Ø§Ø±Ø¬ÙŠ + Ø­ÙØ± Ø´Ø¹Ø§Ø± + ÙØªØ­Ø§Øª Ù…Ø³ÙƒØ© Ù…Ø®ÙÙŠØ© ..."></textarea>

    <label>Ø±ÙØ¹ Ù…Ù„Ù (DXF / PDF / ØµÙˆØ±Ø©)</label>
    <input id="fileInput" type="file" />

    <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©</label>
    <textarea id="notes" placeholder="Ø£ÙŠ Ù…Ù„Ø§Ø­Ø¸Ø§Øª..."></textarea>
  </div>

  <!-- Ø£Ù…Ø± ØªØ´ØºÙŠÙ„ CNC -->
  <div class="card">
    <div class="title">ğŸ“Œ Ø£Ù…Ø± ØªØ´ØºÙŠÙ„ CNC</div>

    <button class="btn btnGreen" onclick="sendCNCOrder()">ğŸ“© Ø¥Ø±Ø³Ø§Ù„ Ø£Ù…Ø± ØªØ´ØºÙŠÙ„ CNC Ù„Ù„Ø£Ø¯Ù…Ù†</button>

    <div style="margin-top:12px" class="boxText" id="cncPreview">Ø³ÙŠØ¸Ù‡Ø± Ù‡Ù†Ø§ Ø£Ù…Ø± Ø§Ù„ØªØ´ØºÙŠÙ„ Ø¨Ø¹Ø¯ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...</div>

    <div class="pdfLink">
      <button class="btn btnDark" onclick="copyText()">ğŸ“‹ Ù†Ø³Ø® Ø£Ù…Ø± Ø§Ù„ØªØ´ØºÙŠÙ„</button>
      <a href="/admin.html">ÙØªØ­ Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø¯Ù…Ù†</a>
    </div>

    <div class="mini">âš ï¸ Ù‡Ø°Ø§ Ø§Ù„Ø¥ØµØ¯Ø§Ø± ÙŠØ­ÙØ¸ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø¯Ø§Ø®Ù„ Ù†ÙØ³ Ø§Ù„Ø¬Ù‡Ø§Ø² (LocalStorage).</div>
  </div>

  <!-- ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø¹Ù…ÙŠÙ„ (Ø¥Ø°Ø§ Ø§Ù„Ø£Ø¯Ù…Ù† Ø£Ø±Ø³Ù„Ù‡Ø§) -->
  <div class="card">
    <div class="title">ğŸ§¾ Ø§Ù„ÙØ§ØªÙˆØ±Ø©</div>
    <div class="mini">Ø¥Ø°Ø§ Ø§Ù„Ø£Ø¯Ù…Ù† Ø¬Ù‡Ù‘Ø² ÙØ§ØªÙˆØ±Ø© ÙˆØ§Ø±Ø³ÙÙ„Ù‡Ø§ Ù„ÙƒØŒ ØªØ¸Ù‡Ø± Ù‡Ù†Ø§.</div>

    <div id="invoiceBox" class="boxText">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙØ§ØªÙˆØ±Ø© Ø­Ø§Ù„ÙŠØ§Ù‹.</div>
    <div id="invoiceDownload" class="pdfLink" style="display:none;">
      <button class="btn btnBlue" onclick="downloadInvoicePDF()">ğŸ“„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙØ§ØªÙˆØ±Ø© PDF</button>
    </div>
  </div>

</div>

<!-- Ù…ÙƒØªØ¨Ø© PDF -->
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<script>
  // ====== Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ø¯Ø®ÙˆÙ„ ======
  const user = localStorage.getItem("pd_current_user");
  const company = localStorage.getItem("pd_current_company");

  if(!user || !company){
    window.location.href = "/index.html";
  }

  document.getElementById("hello").innerText = "Ù…Ø±Ø­Ø¨Ø§Ù‹: " + company;

  function logout(){
    localStorage.removeItem("pd_current_user");
    localStorage.removeItem("pd_current_company");
    window.location.href = "/index.html";
  }

  // ====== Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨ (ØªØ¬ÙŠ Ù…Ù† Ø§Ù„Ø£Ø¯Ù…Ù†) ======
  function loadStatus(){
    const statuses = JSON.parse(localStorage.getItem("pd_statuses") || "{}");
    const st = statuses[user] || "Ù‚ÙŠØ¯ Ø§Ù„ØªØ´ØºÙŠÙ„";
    const badge = document.getElementById("statusBadge");
    if(st === "Ø¬Ø§Ù‡Ø²"){
      badge.className = "badge bDone";
      badge.innerText = "âœ… Ø¬Ø§Ù‡Ø²";
    }else{
      badge.className = "badge bWork";
      badge.innerText = "â³ " + st;
    }
  }
  loadStatus();

  // ====== Ù‚ÙŠØ§Ø³Ø§Øª ======
  const measurementsDiv = document.getElementById("measurements");

  function arrowSVG(direction){
    // Ø³Ù‡Ù… Ù…Ø«Ù„ Ø±Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„: Ø®Ø· + Ø³Ù‡Ù… ÙŠÙˆØ¶Ø­ Ø§ØªØ¬Ø§Ù‡ Ø§Ù„ÙØªØ­Ø©
    // ÙŠÙ…ÙŠÙ† = Ø§Ù„Ø³Ù‡Ù… ÙŠØ±ÙˆØ­ ÙŠÙ…ÙŠÙ† / ÙŠØ³Ø§Ø± = Ø§Ù„Ø³Ù‡Ù… ÙŠØ±ÙˆØ­ ÙŠØ³Ø§Ø±
    const isRight = direction === "ÙŠÙ…ÙŠÙ†";
    const arrow = isRight ? "â¡ï¸" : "â¬…ï¸";
    return `<div style="font-size:22px;font-weight:900">${arrow}</div>`;
  }

  function measurementRow(i){
    const wrapper = document.createElement("div");
    wrapper.className = "tableRow";

    wrapper.innerHTML = `
      <div style="width:30px;font-weight:900">${i+1}</div>

      <div style="flex:1;min-width:120px">
        <label>Ø§Ù„Ø¹Ø±Ø¶ (Ø³Ù…)</label>
        <input type="number" class="w" placeholder="Ù…Ø«Ø§Ù„: 110" />
      </div>

      <div style="flex:1;min-width:120px">
        <label>Ø§Ù„Ø§Ø±ØªÙØ§Ø¹ (Ø³Ù…)</label>
        <input type="number" class="h" placeholder="Ù…Ø«Ø§Ù„: 300" />
      </div>

      <div style="flex:1;min-width:120px">
        <label>Ø§Ù„Ø¹Ø¯Ø¯</label>
        <input type="number" class="q" value="1" />
      </div>

      <div style="flex:1;min-width:170px">
        <label>Ø§ØªØ¬Ø§Ù‡ Ø§Ù„ÙØªØ­Ø©</label>
        <select class="dir">
          <option value="ÙŠÙ…ÙŠÙ†">ÙŠÙ…ÙŠÙ† (Ù…Ù† Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¨ÙŠØª)</option>
          <option value="ÙŠØ³Ø§Ø±">ÙŠØ³Ø§Ø± (Ù…Ù† Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¨ÙŠØª)</option>
        </select>
      </div>

      <div style="width:70px;text-align:center;margin-top:26px" class="arrowBox">${arrowSVG("ÙŠÙ…ÙŠÙ†")}</div>

      <div style="width:90px">
        <button class="btn btnRed" style="width:100%" onclick="this.parentElement.parentElement.remove(); refreshMeasurementNumbers();">Ø­Ø°Ù</button>
      </div>
    `;

    const dirSelect = wrapper.querySelector(".dir");
    const arrowBox = wrapper.querySelector(".arrowBox");
    dirSelect.addEventListener("change", () => {
      arrowBox.innerHTML = arrowSVG(dirSelect.value);
    });

    return wrapper;
  }

  function refreshMeasurementNumbers(){
    const rows = measurementsDiv.querySelectorAll(".tableRow");
    rows.forEach((r, idx) => {
      r.children[0].innerText = idx+1;
    });
  }

  function addMeasurement(){
    const rows = measurementsDiv.querySelectorAll(".tableRow").length;
    measurementsDiv.appendChild(measurementRow(rows));
    refreshMeasurementNumbers();
  }

  // Ø£ÙˆÙ„ ØµÙ Ø§ÙØªØ±Ø§Ø¶ÙŠ
  addMeasurement();

  // ====== Ø§Ù„Ø´ÙŠØªØ§Øª ======
  const SHEET_SIZES = [
    "122x244","122x300","150x300","100x300","100x200","122x350","122x400","150x400"
  ];
  const THICKNESSES = [2,3,4,5,6,7,8,9,10,11,12];

  const sheetsDiv = document.getElementById("sheets");

  function sheetRow(){
    const div = document.createElement("div");
    div.className = "tableRow";

    const sizeOptions = SHEET_SIZES.map(s=>`<option>${s}</option>`).join("");
    const thOptions = THICKNESSES.map(t=>`<option>${t}</option>`).join("");

    div.innerHTML = `
      <div style="flex:1;min-width:180px">
        <label>Ù‚ÙŠØ§Ø³ Ø§Ù„Ø´ÙŠØª</label>
        <select class="sheetSize">${sizeOptions}</select>
      </div>

      <div style="flex:1;min-width:150px">
        <label>Ø§Ù„Ø³Ù…Ø§ÙƒØ© (mm)</label>
        <select class="sheetTh">${thOptions}</select>
      </div>

      <div style="flex:1;min-width:140px">
        <label>Ø§Ù„ÙƒÙ…ÙŠØ©</label>
        <input type="number" class="sheetQty" value="1" min="1" />
      </div>

      <div style="width:90px">
        <button class="btn btnRed" style="width:100%" onclick="this.parentElement.parentElement.remove()">Ø­Ø°Ù</button>
      </div>
    `;
    return div;
  }

  function addSheet(){
    sheetsDiv.appendChild(sheetRow());
  }

  // Ø£ÙˆÙ„ Ø´ÙŠØª Ø§ÙØªØ±Ø§Ø¶ÙŠ
  addSheet();

  // ====== ØªÙˆÙ„ÙŠØ¯ Ø£Ù…Ø± ØªØ´ØºÙŠÙ„ CNC ======
  function getMeasurementsData(){
    const rows = measurementsDiv.querySelectorAll(".tableRow");
    const arr = [];
    rows.forEach((r, idx)=>{
      const w = r.querySelector(".w").value;
      const h = r.querySelector(".h").value;
      const q = r.querySelector(".q").value || 1;
      const dir = r.querySelector(".dir").value;

      if(w && h){
        arr.push({ no: idx+1, width:w, height:h, qty:q, dir });
      }
    });
    return arr;
  }

  function getSheetsData(){
    const rows = sheetsDiv.querySelectorAll(".tableRow");
    const arr = [];
    rows.forEach((r)=>{
      const size = r.querySelector(".sheetSize").value;
      const th = r.querySelector(".sheetTh").value;
      const qty = r.querySelector(".sheetQty").value || 1;
      arr.push({ size, th, qty });
    });
    return arr;
  }

  function buildCNCText(){
    const type = document.getElementById("orderType").value || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯";
    const measures = getMeasurementsData();
    const cut = document.getElementById("cutDetails").value.trim();
    const notes = document.getElementById("notes").value.trim();

    let text = "";
    text += "ğŸ“Œ Ø£Ù…Ø± ØªØ´ØºÙŠÙ„ CNC\n";
    text += "--------------------------\n";
    text += "Ø§Ù„Ø¹Ù…ÙŠÙ„: " + company + "\n";
    text += "Ù†ÙˆØ¹ Ø§Ù„Ø·Ù„Ø¨: " + type + "\n";
    text += "--------------------------\n";
    text += "ğŸ“ Ø§Ù„Ù‚ÙŠØ§Ø³Ø§Øª (Ø³Ù…):\n";

    if(measures.length === 0){
      text += "- Ù„Ø§ ØªÙˆØ¬Ø¯ Ù‚ÙŠØ§Ø³Ø§Øª Ù…Ø¯Ø®Ù„Ø©\n";
    }else{
      measures.forEach(m=>{
        const arrow = (m.dir === "ÙŠÙ…ÙŠÙ†") ? "â¡ï¸" : "â¬…ï¸";
        text += `${m.no}) ${m.width} Ã— ${m.height} | Ø§Ù„Ø¹Ø¯Ø¯: ${m.qty} | Ø§Ù„ÙØªØ­Ø©: ${m.dir} ${arrow}\n`;
      });
    }

    text += "--------------------------\n";
    text += "âœ‚ï¸ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù‚Øµ/Ø§Ù„Ø­ÙØ±:\n";
    text += (cut ? cut : "Ù„Ø§ ÙŠÙˆØ¬Ø¯") + "\n";
    text += "--------------------------\n";
    text += "ğŸ“ Ù…Ù„Ø§Ø­Ø¸Ø§Øª:\n";
    text += (notes ? notes : "Ù„Ø§ ÙŠÙˆØ¬Ø¯") + "\n";
    text += "--------------------------\n";
    text += "âœ… ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ£ÙƒÙŠØ¯ Ù‚Ø¨Ù„ Ø§Ù„ØªÙ†ÙÙŠØ°.\n";

    return text;
  }

  function sendCNCOrder(){
    const cncText = buildCNCText();
    document.getElementById("cncPreview").innerText = cncText;

    const payload = {
      id: "ORD-" + Date.now(),
      user,
      company,
      type: document.getElementById("orderType").value || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯",
      measurements: getMeasurementsData(),
      sheets: getSheetsData(),
      cutDetails: document.getElementById("cutDetails").value.trim(),
      notes: document.getElementById("notes").value.trim(),
      createdAt: new Date().toISOString(),
      cncText
    };

    const orders = JSON.parse(localStorage.getItem("pd_orders") || "[]");
    orders.unshift(payload);
    localStorage.setItem("pd_orders", JSON.stringify(orders));

    alert("âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø£Ù…Ø± ØªØ´ØºÙŠÙ„ CNC Ù„Ù„Ø£Ø¯Ù…Ù† (ØªØ¬Ø±ÙŠØ¨ÙŠ).");
  }

  function copyText(){
    const t = document.getElementById("cncPreview").innerText.trim();
    if(!t || t.includes("Ø³ÙŠØ¸Ù‡Ø± Ù‡Ù†Ø§")){
      return alert("Ø£Ø±Ø³Ù„ Ø£Ù…Ø± Ø§Ù„ØªØ´ØºÙŠÙ„ Ø£ÙˆÙ„Ø§Ù‹");
    }
    navigator.clipboard.writeText(t);
    alert("ğŸ“‹ ØªÙ… Ù†Ø³Ø® Ø£Ù…Ø± Ø§Ù„ØªØ´ØºÙŠÙ„");
  }

  // ====== PDF Ù„Ù„Ø´ÙŠØª ======
  async function downloadSheetsPDF(){
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    const sheets = getSheetsData();

    doc.setFont("helvetica","bold");
    doc.setFontSize(14);
    doc.text("Sheet Order (Supplier)", 14, 15);

    doc.setFontSize(11);
    doc.setFont("helvetica","normal");
    doc.text("Client: " + company, 14, 25);
    doc.text("Date: " + new Date().toLocaleString(), 14, 32);

    let y = 45;
    doc.setFont("helvetica","bold");
    doc.text("Size", 14, y);
    doc.text("Thickness(mm)", 70, y);
    doc.text("Qty", 140, y);

    doc.setFont("helvetica","normal");
    y += 8;

    sheets.forEach((s)=>{
      doc.text(String(s.size), 14, y);
      doc.text(String(s.th), 80, y);
      doc.text(String(s.qty), 140, y);
      y += 8;
      if(y > 280){
        doc.addPage();
        y = 20;
      }
    });

    doc.save("Sheet-Order.pdf");
  }

  // ====== ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø¹Ù…ÙŠÙ„ (ØªØ¬ÙŠ Ù…Ù† Ø§Ù„Ø£Ø¯Ù…Ù†) ======
  function loadInvoice(){
    const invs = JSON.parse(localStorage.getItem("pd_invoices") || "{}");
    const inv = invs[user];
    const box = document.getElementById("invoiceBox");
    const dl = document.getElementById("invoiceDownload");

    if(!inv){
      box.innerText = "Ù„Ø§ ØªÙˆØ¬Ø¯ ÙØ§ØªÙˆØ±Ø© Ø­Ø§Ù„ÙŠØ§Ù‹.";
      dl.style.display = "none";
      return;
    }

    box.innerText = inv.text;
    dl.style.display = "flex";
  }
  loadInvoice();

  async function downloadInvoicePDF(){
    const invs = JSON.parse(localStorage.getItem("pd_invoices") || "{}");
    const inv = invs[user];
    if(!inv) return alert("Ù„Ø§ ØªÙˆØ¬Ø¯ ÙØ§ØªÙˆØ±Ø©");

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    doc.setFont("helvetica","bold");
    doc.setFontSize(16);
    doc.text("Pro Design - Invoice", 14, 16);

    doc.setFontSize(11);
    doc.setFont("helvetica","normal");
    doc.text("Client: " + company, 14, 26);
    doc.text("Date: " + new Date().toLocaleString(), 14, 33);

    const lines = doc.splitTextToSize(inv.text, 180);
    doc.text(lines, 14, 45);

    doc.save("Invoice.pdf");
  }
</script>
</body>
</html>
