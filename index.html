<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø¯Ù…Ù† - Pro Design CNC</title>

  <!-- Ù†ÙØ³ Ø³ØªØ§ÙŠÙ„ Ø¨Ø±Ùˆ Ø¯ÙŠØ²Ø§ÙŠÙ† -->
  <link rel="stylesheet" href="style.css" />

  <style>
    /* ØªØ­Ø³ÙŠÙ†Ø§Øª Ø¨Ø³ÙŠØ·Ø© Ø®Ø§ØµØ© Ø¨Ø§Ù„Ø£Ø¯Ù…Ù† Ø¨Ø¯ÙˆÙ† ØªØ®Ø±ÙŠØ¨ Ø³ØªØ§ÙŠÙ„Ùƒ */
    .orders-list{
      display:flex;
      flex-direction:column;
      gap:10px;
      margin-top:10px;
    }
    .order-item{
      background: rgba(255,255,255,.03);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 12px;
      cursor:pointer;
      transition:.2s ease;
    }
    .order-item:hover{
      border-color: rgba(47,123,255,.35);
      transform: translateY(-1px);
    }
    .order-top{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:6px;
    }
    .order-name{
      font-weight:800;
      font-size:14px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 70%;
    }
    .order-meta{
      color: var(--muted);
      font-size: 12px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }

    .split{
      display:grid;
      grid-template-columns: 1.05fr .95fr;
      gap: 12px;
      align-items:start;
    }
    @media (max-width: 900px){
      .split{ grid-template-columns: 1fr; }
    }

    .empty{
      color: var(--muted);
      text-align:center;
      padding: 14px;
      border: 1px dashed rgba(255,255,255,.12);
      border-radius: var(--radius);
      background: rgba(255,255,255,.02);
      margin-top: 10px;
    }

    .mini-btns{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 10px;
    }
    @media (max-width: 520px){
      .mini-btns{ grid-template-columns: 1fr; }
    }

    .pill{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding: 7px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.03);
      font-size: 12px;
      color: var(--muted);
      gap:6px;
    }

    .file-link{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.03);
      margin-top: 8px;
    }
    .file-link a{
      color: var(--text);
      text-decoration:none;
      font-weight:700;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      max-width: 70%;
    }

    .status-row{
      display:grid;
      grid-template-columns: 1fr;
      gap: 10px;
    }

    .sticky-actions{
      position: sticky;
      bottom: 10px;
      z-index: 20;
      margin-top: 12px;
    }
  </style>
</head>

<body>

  <!-- Topbar -->
  <div class="topbar">
    <div class="container">
      <div class="brand">
        <div class="logo"></div>
        <div style="min-width:0">
          <h1>Pro Design CNC</h1>
          <p>Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø¯Ù…Ù† - Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª ÙˆØ§Ù„ÙÙˆØ§ØªÙŠØ±</p>
        </div>
      </div>

      <button class="btn btn-ghost" style="width:auto; padding:10px 14px" onclick="logout()">
        ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬
      </button>
    </div>
  </div>

  <div class="container">

    <div class="split">

      <!-- Left: Orders -->
      <div class="card">
        <div class="card-title">
          <h2>ğŸ“Œ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h2>
          <span class="pill">Ø¨Ø­Ø« + Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø·Ù„Ø¨</span>
        </div>

        <label>Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨</label>
        <input id="searchInput" type="text" placeholder="Ù…Ø«Ø§Ù„: Ø´Ø±ÙƒØ© Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø£Ùˆ ORD-..." oninput="renderOrders()" />

        <div class="orders-list" id="ordersList"></div>

        <div class="empty" id="ordersEmpty" style="display:none">
          Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹
        </div>
      </div>

      <!-- Right: Order Details -->
      <div class="card">
        <div class="card-title">
          <h2>ğŸ“Œ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ (Ø§Ù„Ø£Ø¯Ù…Ù†)</h2>
          <span id="statusBadge" class="badge working">Ù‚ÙŠØ¯ Ø§Ù„ØªØ´ØºÙŠÙ„</span>
        </div>

        <div id="noSelection" class="empty">
          ğŸ‘‰ Ø§Ø®ØªØ± Ø·Ù„Ø¨ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
        </div>

        <div id="detailsWrap" style="display:none">

          <div class="row">
            <div>
              <label>Ø§Ù„Ø¹Ù…ÙŠÙ„</label>
              <input id="clientName" type="text" disabled />
            </div>
            <div>
              <label>Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨</label>
              <input id="orderId" type="text" disabled />
            </div>
          </div>

          <div class="row">
            <div>
              <label>Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
              <input id="orderDate" type="text" disabled />
            </div>
            <div>
              <label>Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</label>
              <input id="orderStatusText" type="text" disabled />
            </div>
          </div>

          <div class="hr"></div>

          <!-- Status Update -->
          <div class="status-row">
            <label>ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø©</label>
            <select id="statusSelect" onchange="updateBadgePreview()">
              <option value="Ù‚ÙŠØ¯ Ø§Ù„ØªØ´ØºÙŠÙ„">Ù‚ÙŠØ¯ Ø§Ù„ØªØ´ØºÙŠÙ„</option>
              <option value="ØªÙ… Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…">ØªÙ… Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…</option>
              <option value="Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°">Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°</option>
              <option value="ØªÙ… Ø§Ù„ØªÙ†ÙÙŠØ°">ØªÙ… Ø§Ù„ØªÙ†ÙÙŠØ°</option>
              <option value="ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…">ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…</option>
              <option value="Ù…Ø¤Ø¬Ù„">Ù…Ø¤Ø¬Ù„</option>
              <option value="Ù…Ù„ØºÙŠ">Ù…Ù„ØºÙŠ</option>
            </select>

            <button class="btn btn-orange" onclick="saveStatus()">
              Ø­ÙØ¸ Ø§Ù„Ø­Ø§Ù„Ø©
            </button>
          </div>

          <div class="hr"></div>

          <!-- Invoice -->
          <div class="card" style="margin:0; padding:14px; background: rgba(255,255,255,.02)">
            <div class="card-title">
              <h2>ğŸ§¾ Ø§Ù„ÙØ§ØªÙˆØ±Ø© (Pro Design Style)</h2>
              <span class="pill">KD</span>
            </div>

            <div class="row-3">
              <div>
                <label>Ø³Ø¹Ø± Ø§Ù„Ù‚Øµ (KD)</label>
                <input id="cutPrice" type="number" value="0" min="0" step="0.1" />
              </div>
              <div>
                <label>Ø³Ø¹Ø± Ø§Ù„Ø­ÙØ± (KD)</label>
                <input id="engravePrice" type="number" value="0" min="0" step="0.1" />
              </div>
              <div>
                <label>Ø³Ø¹Ø± Ø§Ù„Ø´ÙŠØª/Ø§Ù„Ù…Ø§Ø¯Ø© (KD)</label>
                <input id="sheetPrice" type="number" value="0" min="0" step="0.1" />
              </div>
            </div>

            <div class="row">
              <div>
                <label>Ø§Ù„Ø®ØµÙ… (KD)</label>
                <input id="discount" type="number" value="0" min="0" step="0.1" />
              </div>
              <div>
                <label>Ù…Ù„Ø§Ø­Ø¸Ø©</label>
                <input id="invoiceNote" type="text" placeholder="Ù…Ø«Ø§Ù„: Ø´Ø§Ù…Ù„ Ø§Ù„ØªØ±ÙƒÙŠØ¨" />
              </div>
            </div>

            <div class="help" id="totalText">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: 0 KD</div>

            <div class="mini-btns sticky-actions">
              <button class="btn btn-green" onclick="saveInvoice()">
                Ø¥Ù†Ø´Ø§Ø¡ / ØªØ­Ø¯ÙŠØ« ÙØ§ØªÙˆØ±Ø©
              </button>
              <button class="btn btn-blue" onclick="sendInvoiceToClient()">
                Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ù„Ù„Ø¹Ù…ÙŠÙ„
              </button>
            </div>

            <div class="empty" id="invoiceEmpty" style="display:none; margin-top:10px">
              Ù„Ø§ ØªÙˆØ¬Ø¯ ÙØ§ØªÙˆØ±Ø©
            </div>
          </div>

          <div class="hr"></div>

          <!-- Files -->
          <div>
            <div class="card-title">
              <h2>ğŸ“ Ù…Ù„ÙØ§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„</h2>
              <span class="pill">DXF / PDF / ØµÙˆØ±Ø©</span>
            </div>

            <div id="filesBox"></div>
            <div class="empty" id="filesEmpty" style="display:none">
              Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ù„ÙØ§Øª Ù…Ø±ÙÙˆØ¹Ø©
            </div>
          </div>

        </div>
      </div>

    </div>

  </div>

<script>
/* =========================
   Admin Page Logic
   - Local demo storage
   - Later connect to backend
========================= */

const LS_KEY = "prodesign_orders_v1";

let selectedOrderId = null;

function getOrders(){
  try{
    const raw = localStorage.getItem(LS_KEY);
    if(!raw) return [];
    const arr = JSON.parse(raw);
    if(!Array.isArray(arr)) return [];
    return arr;
  }catch(e){
    return [];
  }
}

function setOrders(arr){
  localStorage.setItem(LS_KEY, JSON.stringify(arr));
}

function seedDemoIfEmpty(){
  const orders = getOrders();
  if(orders.length > 0) return;

  const demo = [
    {
      id: "ORD-1769157412912",
      clientName: "Ø´Ø±ÙƒØ© Ø§Ù„Ø¹Ù…ÙŠÙ„ 1",
      createdAt: new Date().toISOString(),
      status: "Ù‚ÙŠØ¯ Ø§Ù„ØªØ´ØºÙŠÙ„",
      files: [],
      invoice: null
    },
    {
      id: "ORD-1768951223099",
      clientName: "Ø´Ø±ÙƒØ© Ø§Ù„Ø¹Ù…ÙŠÙ„ 2",
      createdAt: new Date().toISOString(),
      status: "Ù‚ÙŠØ¯ Ø§Ù„ØªØ´ØºÙŠÙ„",
      files: [],
      invoice: null
    }
  ];
  setOrders(demo);
}

function formatDate(iso){
  try{
    const d = new Date(iso);
    return d.toLocaleString("ar-KW");
  }catch(e){
    return iso || "-";
  }
}

function renderOrders(){
  const orders = getOrders();
  const q = (document.getElementById("searchInput").value || "").trim().toLowerCase();

  const list = document.getElementById("ordersList");
  const empty = document.getElementById("ordersEmpty");
  list.innerHTML = "";

  const filtered = orders.filter(o=>{
    const a = (o.clientName || "").toLowerCase();
    const b = (o.id || "").toLowerCase();
    return !q || a.includes(q) || b.includes(q);
  });

  if(filtered.length === 0){
    empty.style.display = "block";
    return;
  }else{
    empty.style.display = "none";
  }

  filtered.sort((a,b)=> (b.createdAt || "").localeCompare(a.createdAt || ""));

  filtered.forEach(order=>{
    const div = document.createElement("div");
    div.className = "order-item";
    div.onclick = ()=> selectOrder(order.id);

    const badgeClass = order.status === "ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…" ? "ready" : "working";

    div.innerHTML = `
      <div class="order-top">
        <div class="order-name">${order.clientName || "Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…"}</div>
        <span class="badge ${badgeClass}">${order.status || "Ù‚ÙŠØ¯ Ø§Ù„ØªØ´ØºÙŠÙ„"}</span>
      </div>
      <div class="order-meta">
        <span>ğŸ“Œ ${order.id}</span>
        <span>ğŸ•’ ${formatDate(order.createdAt)}</span>
      </div>
    `;

    list.appendChild(div);
  });
}

function selectOrder(orderId){
  const orders = getOrders();
  const order = orders.find(o=>o.id === orderId);
  if(!order) return;

  selectedOrderId = orderId;

  document.getElementById("noSelection").style.display = "none";
  document.getElementById("detailsWrap").style.display = "block";

  document.getElementById("clientName").value = order.clientName || "";
  document.getElementById("orderId").value = order.id || "";
  document.getElementById("orderDate").value = formatDate(order.createdAt);
  document.getElementById("orderStatusText").value = order.status || "Ù‚ÙŠØ¯ Ø§Ù„ØªØ´ØºÙŠÙ„";

  document.getElementById("statusSelect").value = order.status || "Ù‚ÙŠØ¯ Ø§Ù„ØªØ´ØºÙŠÙ„";
  updateBadgePreview();

  // Invoice
  if(order.invoice){
    document.getElementById("invoiceEmpty").style.display = "none";
    document.getElementById("cutPrice").value = order.invoice.cutPrice ?? 0;
    document.getElementById("engravePrice").value = order.invoice.engravePrice ?? 0;
    document.getElementById("sheetPrice").value = order.invoice.sheetPrice ?? 0;
    document.getElementById("discount").value = order.invoice.discount ?? 0;
    document.getElementById("invoiceNote").value = order.invoice.note ?? "";
  }else{
    document.getElementById("invoiceEmpty").style.display = "block";
    document.getElementById("cutPrice").value = 0;
    document.getElementById("engravePrice").value = 0;
    document.getElementById("sheetPrice").value = 0;
    document.getElementById("discount").value = 0;
    document.getElementById("invoiceNote").value = "";
  }
  calcTotal();

  // Files
  renderFiles(order.files || []);
}

function updateBadgePreview(){
  const status = document.getElementById("statusSelect").value;
  const badge = document.getElementById("statusBadge");

  badge.textContent = status;

  // Ù„ÙˆÙ† Ø§Ù„Ø¨Ø§Ø¯Ø¬ Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ù„Ø©
  if(status === "ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…" || status === "ØªÙ… Ø§Ù„ØªÙ†ÙÙŠØ°"){
    badge.className = "badge ready";
  }else{
    badge.className = "badge working";
  }
}

function saveStatus(){
  if(!selectedOrderId) return alert("Ø§Ø®ØªØ± Ø·Ù„Ø¨ Ø£ÙˆÙ„Ø§Ù‹");

  const orders = getOrders();
  const idx = orders.findIndex(o=>o.id === selectedOrderId);
  if(idx === -1) return;

  const newStatus = document.getElementById("statusSelect").value;
  orders[idx].status = newStatus;

  setOrders(orders);

  document.getElementById("orderStatusText").value = newStatus;
  updateBadgePreview();
  renderOrders();

  alert("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø­Ø§Ù„Ø© âœ…");
}

function calcTotal(){
  const cut = Number(document.getElementById("cutPrice").value || 0);
  const engrave = Number(document.getElementById("engravePrice").value || 0);
  const sheet = Number(document.getElementById("sheetPrice").value || 0);
  const discount = Number(document.getElementById("discount").value || 0);

  const total = Math.max(0, (cut + engrave + sheet) - discount);
  document.getElementById("totalText").textContent = `Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${total.toFixed(2)} KD`;
  return total;
}

["cutPrice","engravePrice","sheetPrice","discount"].forEach(id=>{
  document.addEventListener("input", (e)=>{
    if(e.target && e.target.id === id) calcTotal();
  });
});

function saveInvoice(){
  if(!selectedOrderId) return alert("Ø§Ø®ØªØ± Ø·Ù„Ø¨ Ø£ÙˆÙ„Ø§Ù‹");

  const orders = getOrders();
  const idx = orders.findIndex(o=>o.id === selectedOrderId);
  if(idx === -1) return;

  const invoice = {
    cutPrice: Number(document.getElementById("cutPrice").value || 0),
    engravePrice: Number(document.getElementById("engravePrice").value || 0),
    sheetPrice: Number(document.getElementById("sheetPrice").value || 0),
    discount: Number(document.getElementById("discount").value || 0),
    note: document.getElementById("invoiceNote").value || "",
    total: calcTotal(),
    updatedAt: new Date().toISOString()
  };

  orders[idx].invoice = invoice;
  setOrders(orders);

  document.getElementById("invoiceEmpty").style.display = "none";
  alert("ØªÙ… Ø­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø© âœ…");
}

function sendInvoiceToClient(){
  if(!selectedOrderId) return alert("Ø§Ø®ØªØ± Ø·Ù„Ø¨ Ø£ÙˆÙ„Ø§Ù‹");

  const orders = getOrders();
  const order = orders.find(o=>o.id === selectedOrderId);
  if(!order) return;

  if(!order.invoice){
    return alert("Ù„Ø§ ØªÙˆØ¬Ø¯ ÙØ§ØªÙˆØ±Ø© Ù„Ø¥Ø±Ø³Ø§Ù„Ù‡Ø§ âŒ");
  }

  // Ø­Ø§Ù„ÙŠØ§Ù‹ Demo ÙÙ‚Ø·
  alert("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ù„Ù„Ø¹Ù…ÙŠÙ„ (ØªØ¬Ø±ÙŠØ¨ÙŠ) âœ…\nÙ„Ø§Ø­Ù‚Ø§Ù‹ Ù†Ø±Ø¨Ø·Ù‡Ø§ ÙˆØ§ØªØ³Ø§Ø¨/Ø¥ÙŠÙ…ÙŠÙ„.");
}

function renderFiles(files){
  const box = document.getElementById("filesBox");
  const empty = document.getElementById("filesEmpty");

  box.innerHTML = "";

  if(!files || files.length === 0){
    empty.style.display = "block";
    return;
  }
  empty.style.display = "none";

  files.forEach(f=>{
    const div = document.createElement("div");
    div.className = "file-link";
    div.innerHTML = `
      <a href="${f.url || "#"}" target="_blank">${f.name || "Ù…Ù„Ù"}</a>
      <span class="pill">ğŸ“</span>
    `;
    box.appendChild(div);
  });
}

function logout(){
  // Ù„Ùˆ Ø¹Ù†Ø¯Ùƒ auth Ø­Ù‚ÙŠÙ‚ÙŠ Ø±Ø§Ø­ Ù†Ù…Ø³Ø­ Ø§Ù„ØªÙˆÙƒÙ†
  localStorage.removeItem("prodesign_session");
  window.location.href = "index.html";
}

// init
seedDemoIfEmpty();
renderOrders();
</script>

</body>
</html>
