<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Pro Design - Ø£Ù…Ø± ØªØ´ØºÙŠÙ„ CNC</title>
  <style>
    body{font-family:Arial;background:#f5f6fa;margin:0}
    .wrap{max-width:900px;margin:20px auto;padding:12px}
    .card{background:#fff;border-radius:18px;padding:16px;margin-bottom:14px;box-shadow:0 6px 22px rgba(0,0,0,.08)}
    h1{margin:0}
    .sub{color:#666;margin-top:4px}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    label{font-weight:800;display:block;margin:6px 0}
    input,select,textarea{width:100%;padding:12px;border-radius:14px;border:1px solid #ddd;font-size:16px}
    textarea{min-height:90px}
    .btn{padding:14px;border:0;border-radius:14px;font-size:18px;font-weight:900;cursor:pointer}
    .blue{background:#1f6feb;color:#fff}
    .black{background:#111;color:#fff}
    .mini{padding:10px 12px;border-radius:12px;font-weight:800;border:1px solid #ddd;background:#fafafa;cursor:pointer}
    .row{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .sheetRow{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-top:10px}
    .muted{color:#777;font-size:13px}
    canvas{width:100%;max-width:420px;border-radius:16px;border:1px solid #ddd;background:#fff}
  </style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>Pro Design</h1>
    <div class="sub">Ø¥Ø±Ø³Ø§Ù„ Ø£Ù…Ø± ØªØ´ØºÙŠÙ„ CNC (Ù…Ø¹ Ù…Ø®Ø·Ø· Ø±Ø³Ù… Ø¯Ù‚ÙŠÙ‚)</div>
  </div>

  <div class="card">
    <div class="grid2">
      <div>
        <label>Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</label>
        <input id="customerName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ© / Ø§Ù„Ø¹Ù…ÙŠÙ„">
      </div>
      <div>
        <label>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
        <input id="phone" placeholder="Ù…Ø«Ø§Ù„: 94016181">
      </div>
    </div>

    <div class="grid2">
      <div>
        <label>Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</label>
        <select id="jobType">
          <option>Ù‚Øµ</option>
          <option>Ø­ÙØ±</option>
          <option>Ù‚Øµ + Ø­ÙØ±</option>
        </select>
      </div>
      <div>
        <label>Ù†ÙˆØ¹ Ø§Ù„Ù…Ø§Ø¯Ø©</label>
        <select id="materialType">
          <option>Ø§Ù„Ø£Ù„Ù…Ù†ÙŠÙˆÙ…</option>
          <option>Ø§Ù„Ø§Ù„ÙƒØ¨ÙˆÙ†Ø¯</option>
          <option>Ø§ÙƒØ±ÙŠÙ„ÙŠÙƒ</option>
          <option>Ø­Ø¯ÙŠØ¯</option>
          <option>Ø§Ø³ØªÙŠÙ„</option>
        </select>
      </div>
    </div>

    <div class="grid2">
      <div>
        <label>Ø§ØªØ¬Ø§Ù‡ ÙØªØ­Ø© Ø§Ù„Ø¨Ø§Ø¨</label>
        <select id="doorOpenDirection">
          <option>ÙŠÙ…ÙŠÙ†</option>
          <option>ÙŠØ³Ø§Ø±</option>
        </select>
      </div>
      <div>
        <label>Ø¹Ø±Ø¶ Ø®Ø· Ø§Ù„Ø­ÙØ±</label>
        <select id="lineWidth">
          <option>4mm</option><option>6mm</option><option>8mm</option><option>10mm</option>
          <option>12mm</option><option>15mm</option><option>20mm</option><option>25mm</option>
          <option>3cm</option><option>4cm</option>
        </select>
      </div>
    </div>

    <div class="card" style="background:#fafafa">
      <h3 style="margin:0 0 10px">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø´ÙŠØª (Ø£ÙƒØ«Ø± Ù…Ù† Ù‚ÙŠØ§Ø³ + Ø³Ù…Ø§ÙƒØ© + ÙƒÙ…ÙŠØ©)</h3>
      <div id="sheetsBox"></div>
      <div class="row">
        <button class="btn black" type="button" onclick="addSheetRow()">+ Ø¥Ø¶Ø§ÙØ© Ù‚ÙŠØ§Ø³ Ø´ÙŠØª</button>
        <button class="btn black" type="button" onclick="clearSheets()">Ù…Ø³Ø­</button>
      </div>
      <div class="muted">ÙƒÙ„ Ø³Ø·Ø± = Ù‚ÙŠØ§Ø³ + Ø³Ù…Ø§ÙƒØ© + ÙƒÙ…ÙŠØ©</div>
    </div>

    <div class="card" style="background:#fafafa">
      <h3 style="margin:0 0 10px">ğŸ“ Ø§Ù„Ù…Ø®Ø·Ø· Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ (Ø­Ø³Ø¨ Ø§Ù„Ù‚ÙŠØ§Ø³Ø§Øª)</h3>

      <div class="grid2">
        <div>
          <label>Ø¹Ø±Ø¶ Ø§Ù„Ø¨Ø§Ø¨ (Ø³Ù…)</label>
          <input id="doorW" type="number" value="100">
        </div>
        <div>
          <label>Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„Ø¨Ø§Ø¨ (Ø³Ù…)</label>
          <input id="doorH" type="number" value="220">
        </div>
      </div>

      <div class="grid2">
        <div>
          <label>Ø¬Ù‡Ø© Ø§Ù„Ù…ÙØµÙ„Ø§Øª</label>
          <select id="hingeSide">
            <option>ÙŠÙ…ÙŠÙ†</option>
            <option>ÙŠØ³Ø§Ø±</option>
          </select>
        </div>
        <div>
          <label>Ø´ÙƒÙ„ Ø§Ù„ØªØµÙ…ÙŠÙ…</label>
          <select id="designType">
            <option value="horizontal">Ø®Ø·ÙˆØ· Ø¹Ø±Ø¶ÙŠØ©</option>
            <option value="vertical">Ø®Ø·ÙˆØ· Ø·ÙˆÙ„ÙŠØ©</option>
          </select>
        </div>
      </div>

      <div class="grid2">
        <div>
          <label>Ø§Ù„Ù…Ø³Ø§ÙØ© Ø¨ÙŠÙ† Ø§Ù„Ø®Ø·ÙˆØ· (Ø³Ù…)</label>
          <input id="lineGap" type="number" value="20">
        </div>
        <div>
          <label>Ø³Ù…Ø§ÙƒØ© Ø§Ù„Ø®Ø· (mm)</label>
          <input id="lineThickness" type="number" value="10">
        </div>
      </div>

      <hr style="margin:14px 0;border:0;border-top:1px solid #e5e7eb">

      <h4 style="margin:0 0 8px">ğŸªŸ Ø§Ù„Ø¬Ø§Ù… (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</h4>
      <div class="grid2">
        <div>
          <label>ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¬Ø§Ù…</label>
          <select id="glassEnabled">
            <option value="no">Ù„Ø§</option>
            <option value="yes">Ù†Ø¹Ù…</option>
          </select>
        </div>
        <div>
          <label>Ù…ÙƒØ§Ù† Ø§Ù„Ø¬Ø§Ù… (Ø¹Ù…ÙˆØ¯ÙŠ)</label>
          <select id="glassVPos">
            <option value="top">Ù…Ù† ÙÙˆÙ‚</option>
            <option value="middle">ÙˆØ³Ø·</option>
            <option value="bottom">Ù…Ù† ØªØ­Øª</option>
          </select>
        </div>
      </div>

      <div class="grid2">
        <div>
          <label>Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø§Ù… (Ø³Ù…)</label>
          <input id="glassW" type="number" value="20">
        </div>
        <div>
          <label>Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„Ø¬Ø§Ù… (Ø³Ù…)</label>
          <input id="glassH" type="number" value="60">
        </div>
      </div>

      <div class="grid2">
        <div>
          <label>Ø¨Ø¹Ø¯ Ø§Ù„Ø¬Ø§Ù… Ù…Ù† ÙÙˆÙ‚ (Ø³Ù…)</label>
          <input id="glassTop" type="number" value="15">
        </div>
        <div>
          <label>Ø¨Ø¹Ø¯ Ø§Ù„Ø¬Ø§Ù… Ù…Ù† ØªØ­Øª (Ø³Ù…)</label>
          <input id="glassBottom" type="number" value="15">
        </div>
      </div>

      <div class="grid2">
        <div>
          <label>Ø§Ù„Ù…Ø±Ø¬Ø¹ Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ Ù„Ù„Ø¬Ø§Ù…</label>
          <select id="glassSideRef">
            <option value="lock">Ø·Ø±Ù Ø§Ù„Ù‚ÙÙ„</option>
            <option value="hinge">Ø·Ø±Ù Ø§Ù„Ù…ÙØµÙ„Ø§Øª</option>
          </select>
        </div>
        <div>
          <label>Ø¨Ø¹Ø¯ Ø§Ù„Ø¬Ø§Ù… Ø¹Ù† Ø§Ù„Ø·Ø±Ù Ø§Ù„Ù…Ø®ØªØ§Ø± (Ø³Ù…)</label>
          <input id="glassSideOffset" type="number" value="10">
        </div>
      </div>

      <hr style="margin:14px 0;border:0;border-top:1px solid #e5e7eb">

      <h4 style="margin:0 0 8px">ğŸ§² Ø§Ù„Ù…Ø³ÙƒØ© Ø§Ù„Ù…Ø®ÙÙŠØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</h4>
      <div class="grid2">
        <div>
          <label>Ù†ÙˆØ¹ Ø§Ù„Ù…Ø³ÙƒØ©</label>
          <select id="handleType">
            <option value="hidden">Ù…Ø®ÙÙŠØ©</option>
            <option value="normal">Ø¹Ø§Ø¯ÙŠØ©</option>
          </select>
        </div>
        <div>
          <label>Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ÙƒØ©</label>
          <select id="handleSide">
            <option value="lock">Ø·Ø±Ù Ø§Ù„Ù‚ÙÙ„</option>
            <option value="hinge">Ø·Ø±Ù Ø§Ù„Ù…ÙØµÙ„Ø§Øª</option>
          </select>
        </div>
      </div>

      <div class="grid2">
        <div>
          <label>Ø·ÙˆÙ„ Ø§Ù„Ù…Ø³ÙƒØ© (Ø³Ù…)</label>
          <input id="handleH" type="number" value="30">
        </div>
        <div>
          <label>Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø³ÙƒØ© (Ø³Ù…)</label>
          <input id="handleW" type="number" value="4">
        </div>
      </div>

      <div class="grid2">
        <div>
          <label>Ø¨Ø¹Ø¯ Ø§Ù„Ù…Ø³ÙƒØ© Ù…Ù† ÙÙˆÙ‚ (Ø³Ù…)</label>
          <input id="handleTop" type="number" value="90">
        </div>
        <div>
          <label>Ø¨Ø¹Ø¯ Ø§Ù„Ù…Ø³ÙƒØ© Ø¹Ù† Ø§Ù„Ø·Ø±Ù Ø§Ù„Ù…Ø®ØªØ§Ø± (Ø³Ù…)</label>
          <input id="handleSideOffset" type="number" value="6">
        </div>
      </div>

      <div class="row">
        <button class="btn black" type="button" onclick="drawDoorAdvanced()">ğŸ¨ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ø³Ù…</button>
      </div>

      <div style="margin-top:10px">
        <canvas id="doorCanvas" width="420" height="650"></canvas>
      </div>

      <hr style="margin:14px 0;border:0;border-top:1px solid #e5e7eb">

      <h4 style="margin:0 0 8px">ğŸ“Œ Ù‚ÙŠØ§Ø³Ø§Øª Ø§Ù„Ø·Ù„Ø¨ (ÙƒÙ…Ø§ ÙƒØªØ¨Ù‡Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„)</h4>
      <textarea id="orderMeasurements"
        placeholder="Ù…Ø«Ø§Ù„: Ø¨Ø§Ø¨ 100x220 / Ø¯Ø±ÙÙ‡ 90x210 / ÙÙŠÙƒØ³ 70x50 ..."></textarea>
    </div>

    <label>Ù…Ù„Ù / ØµÙˆØ±Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
    <input id="file" type="file" accept="image/*,.pdf,.dxf,.dwg">

    <button class="btn blue" style="width:100%;margin-top:12px" onclick="sendOrder()">ğŸš€ Ø¥Ø±Ø³Ø§Ù„ Ø£Ù…Ø± Ø§Ù„ØªØ´ØºÙŠÙ„</button>
    <div class="muted">Ø¨Ø¹Ø¯ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ ÙŠØ¹Ø·ÙŠÙƒ Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨ (Ø¨Ø¯ÙˆÙ† ØªØ­ÙˆÙŠÙ„ Ù„ØµÙØ­Ø© Ø«Ø§Ù†ÙŠØ©)</div>
  </div>

  <div class="card">
    <a href="/admin.html">ÙØªØ­ Ø§Ù„Ø£Ø¯Ù…Ù†</a>
  </div>
</div>

<script>
let sheets = [];

function addSheetRow(size="122x244", thickness="3mm", qty="1"){
  sheets.push({size, thickness, qty});
  renderSheets();
}
function clearSheets(){
  sheets = [];
  renderSheets();
}
function renderSheets(){
  const box = document.getElementById("sheetsBox");
  box.innerHTML = "";
  sheets.forEach((s, i)=>{
    const row = document.createElement("div");
    row.className = "sheetRow";
    row.innerHTML = `
      <div>
        <label>Ø§Ù„Ù‚ÙŠØ§Ø³</label>
        <input value="${s.size}" oninput="sheets[${i}].size=this.value">
      </div>
      <div>
        <label>Ø§Ù„Ø³Ù…Ø§ÙƒØ©</label>
        <select onchange="sheets[${i}].thickness=this.value">
          ${["2mm","3mm","4mm","5mm","6mm","8mm","10mm","12mm"].map(x=>`<option ${x===s.thickness?"selected":""}>${x}</option>`).join("")}
        </select>
      </div>
      <div>
        <label>Ø§Ù„ÙƒÙ…ÙŠØ©</label>
        <input type="number" value="${s.qty}" oninput="sheets[${i}].qty=this.value">
      </div>
    `;
    const del = document.createElement("button");
    del.className="mini";
    del.textContent="Ø­Ø°Ù";
    del.onclick=()=>{ sheets.splice(i,1); renderSheets(); };
    box.appendChild(row);
    box.appendChild(del);
    box.appendChild(document.createElement("hr"));
  });
}
addSheetRow();

function cmToPx(cm, scale){ return cm * scale; }

function drawDoorAdvanced(){
  const doorW = Number(document.getElementById("doorW").value || 100);
  const doorH = Number(document.getElementById("doorH").value || 220);

  const hingeSide = document.getElementById("hingeSide").value;
  const designType = document.getElementById("designType").value;
  const lineGap = Number(document.getElementById("lineGap").value || 20);
  const lineThickness = Number(document.getElementById("lineThickness").value || 10);

  const glassEnabled = document.getElementById("glassEnabled").value;
  const glassVPos = document.getElementById("glassVPos").value;
  const glassW = Number(document.getElementById("glassW").value || 20);
  const glassH = Number(document.getElementById("glassH").value || 60);
  const glassTop = Number(document.getElementById("glassTop").value || 15);
  const glassBottom = Number(document.getElementById("glassBottom").value || 15);
  const glassSideRef = document.getElementById("glassSideRef").value;
  const glassSideOffset = Number(document.getElementById("glassSideOffset").value || 10);

  const handleType = document.getElementById("handleType").value;
  const handleSide = document.getElementById("handleSide").value;
  const handleH = Number(document.getElementById("handleH").value || 30);
  const handleW = Number(document.getElementById("handleW").value || 4);
  const handleTop = Number(document.getElementById("handleTop").value || 90);
  const handleSideOffset = Number(document.getElementById("handleSideOffset").value || 6);

  const c = document.getElementById("doorCanvas");
  const ctx = c.getContext("2d");
  ctx.clearRect(0,0,c.width,c.height);

  const pad = 50;
  const scale = Math.min((c.width - pad*2)/doorW, (c.height - pad*2)/doorH);

  const x0 = (c.width - doorW*scale)/2;
  const y0 = (c.height - doorH*scale)/2;
  const dw = doorW*scale;
  const dh = doorH*scale;

  ctx.lineWidth = 4;
  ctx.strokeRect(x0, y0, dw, dh);

  ctx.font = "14px Arial";
  ctx.fillText(`Ø¨Ø§Ø¨: ${doorW}x${doorH} Ø³Ù…`, 10, 18);
  ctx.fillText(`Ù…ÙØµÙ„Ø§Øª: ${hingeSide}`, 10, 36);

  const lockSide = hingeSide === "ÙŠÙ…ÙŠÙ†" ? "ÙŠØ³Ø§Ø±" : "ÙŠÙ…ÙŠÙ†";
  ctx.fillText(`Ù‚ÙÙ„: ${lockSide}`, 10, 54);

  ctx.lineWidth = Math.max(1, lineThickness * 0.08);
  const gapPx = cmToPx(lineGap, scale);

  if(designType === "horizontal"){
    for(let y = y0 + gapPx; y < y0 + dh - gapPx; y += gapPx){
      ctx.beginPath();
      ctx.moveTo(x0 + 10, y);
      ctx.lineTo(x0 + dw - 10, y);
      ctx.stroke();
    }
  }else{
    for(let x = x0 + gapPx; x < x0 + dw - gapPx; x += gapPx){
      ctx.beginPath();
      ctx.moveTo(x, y0 + 10);
      ctx.lineTo(x, y0 + dh - 10);
      ctx.stroke();
    }
  }

  function sideX(ref, offsetCm){
    const side = (ref === "hinge") ? hingeSide : lockSide;
    const off = cmToPx(offsetCm, scale);
    if(side === "ÙŠØ³Ø§Ø±"){
      return x0 + off;
    }else{
      return x0 + dw - off;
    }
  }

  if(glassEnabled === "yes"){
    const gw = cmToPx(glassW, scale);
    const gh = cmToPx(glassH, scale);

    let gy = y0 + cmToPx(glassTop, scale);
    if(glassVPos === "bottom"){
      gy = y0 + dh - cmToPx(glassBottom, scale) - gh;
    }
    if(glassVPos === "middle"){
      gy = y0 + (dh - gh)/2;
    }

    const anchorX = sideX(glassSideRef, glassSideOffset);
    const sideUsed = (glassSideRef === "hinge") ? hingeSide : lockSide;
    const gx = (sideUsed === "ÙŠØ³Ø§Ø±") ? anchorX : anchorX - gw;

    ctx.setLineDash([8,6]);
    ctx.lineWidth = 2;
    ctx.strokeRect(gx, gy, gw, gh);
    ctx.setLineDash([]);
    ctx.font = "12px Arial";
    ctx.fillText("Ø¬Ø§Ù…", gx + 6, gy - 6);
  }

  if(handleType === "hidden"){
    const hw = cmToPx(handleW, scale);
    const hh = cmToPx(handleH, scale);
    const hy = y0 + cmToPx(handleTop, scale);

    const anchorX = sideX(handleSide, handleSideOffset);
    const sideUsed = (handleSide === "hinge") ? hingeSide : lockSide;
    const hx = (sideUsed === "ÙŠØ³Ø§Ø±") ? anchorX : anchorX - hw;

    ctx.lineWidth = 2;
    ctx.strokeRect(hx, hy, hw, hh);
    ctx.font = "12px Arial";
    ctx.fillText("Ù…Ø³ÙƒØ© Ù…Ø®ÙÙŠØ©", hx - 10, hy - 6);
  }

  window.doorSketch = c.toDataURL("image/png");
}

["doorW","doorH","hingeSide","designType","lineGap","lineThickness",
 "glassEnabled","glassVPos","glassW","glassH","glassTop","glassBottom","glassSideRef","glassSideOffset",
 "handleType","handleSide","handleW","handleH","handleTop","handleSideOffset"
].forEach(id=>{
  const el = document.getElementById(id);
  if(el){ el.addEventListener("input", drawDoorAdvanced); el.addEventListener("change", drawDoorAdvanced); }
});
setTimeout(drawDoorAdvanced, 200);

async function sendOrder(){
  const fd = new FormData();
  fd.append("customerName", document.getElementById("customerName").value || "");
  fd.append("phone", document.getElementById("phone").value || "");
  fd.append("jobType", document.getElementById("jobType").value || "");
  fd.append("materialType", document.getElementById("materialType").value || "");
  fd.append("doorOpenDirection", document.getElementById("doorOpenDirection").value || "");
  fd.append("lineWidth", document.getElementById("lineWidth").value || "");

  fd.append("orderMeasurements", document.getElementById("orderMeasurements").value || "");
  fd.append("sheets", JSON.stringify(sheets));
  fd.append("doorSketch", window.doorSketch || "");

  const f = document.getElementById("file").files[0];
  if(f) fd.append("file", f);

  const r = await fetch("/api/orders", { method:"POST", body: fd });
  const j = await r.json();
  if(!j.ok){ alert("ØµØ§Ø± Ø®Ø·Ø£ Ø¨Ø§Ù„Ø¥Ø±Ø³Ø§Ù„"); return; }
  alert("ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ âœ… Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨: " + j.id);
  // Ù„Ø§ ØªØ­ÙˆÙŠÙ„ Ù„Ø£ÙŠ ØµÙØ­Ø© Ø«Ø§Ù†ÙŠØ©
}
</script>
</body>
</html>
